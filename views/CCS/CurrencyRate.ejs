<!DOCTYPE html>
<html lang="en" dir="ltr">
<header>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.purple-indigo.min.css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/JS/getmdl/getmdl-select.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script defer src="/JS/getmdl/getmdl-select.min.js"></script>
    <!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <title>CCS - Currency</title>
</header>

<body style="background-color: white;">
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">CURRENCY RATE</span>
                <div class="mdl-layout-spacer"></div>

            </div>

        </header>
        <%- include ("partials/navTemplate.ejs"); -%>
            <main class="mdl-layout__content">
                <div class="mdl-card mdl-shadow--6dp" style="width: 65% ; margin: 10px auto;">
                    <table class="mdl-data-table mdl-js-data-table" style="border: none; padding: 5px;font-size: 18px;">
                        <thead style="background-color:indigo;">
                            <tr>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">USD</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">EUR</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">VND</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">THỜI GIAN</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">TÀI KHOẢN</th>
                                <th class="mdl-data-table__cell--non-numeric" style="color: white;">CẬP NHẬT</th>
                            </tr>
                        </thead>
                        <tbody id="table_body_currency" style="padding: 0;margin: 0 auto;">
                        </tbody>
                    </table>
                </div>
            </main>

            <dialog style="border-radius: 20px; border: none; padding: 0; background-color: transparent;"
                id="dialog_currency">
                <div class="demo-card-wide mdl-card mdl-shadow--2dp" style="width: 420px; border-radius: 20px;">
                    <div class="mdl-card__title" style="background-color: indigo; color: white; ">
                        <h3 class="mdl-card__title-text">CHANGE CURRENCY RATE</h3>
                    </div>
                    <div class="mdl-card__supporting-text"
                        style=" height: 150px;padding: 0;margin-top: 0;margin-left: 0;margin-right: 0; width: 100%;">

                        <div class="mdl-cell mdl-cell--12-col" style="text-align:center;height: 40px;padding:0px;">
                            <div class="mdl-textfield mdl-js-textfield mdl-cell--3-col">
                                <label class="mdl-textfield__label"
                                    style="color:green;text-align: left; margin: auto;">EUR</label>
                            </div>

                            <div class="mdl-cell--9-col mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                                    id="txt_eur" style="color: black;">
                                <span class="mdl-textfield__error">Input is not a number!</span>
                            </div>
                        </div>

                        <div class="mdl-cell mdl-cell--12-col" style="text-align:center;height: 40px;padding:0px;">
                            <div class="mdl-textfield mdl-js-textfield mdl-cell--3-col">
                                <label class="mdl-textfield__label"
                                    style="color:green;text-align: left; margin: auto;">VND</label>
                            </div>

                            <div class="mdl-cell--9-col mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                <input class="mdl-textfield__input" type="text" pattern="-?[0-9]*(\.[0-9]+)?"
                                    id="txt_vnd" style="color: black;">
                                <span class="mdl-textfield__error">Input is not a number!</span>
                            </div>
                        </div>
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="btn_done"
                            style="background-color: green;color: white;border-radius: 10px;"
                            onclick="update_currecny_rate()">
                            <i class="material-icons">update</i>
                            UPDATE
                        </button>
                    </div>
                    <div class="mdl-card__menu">
                        <button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect" id="btn_close"
                            style="background-color: red; color: white;" onclick="close_dialog_currency()">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                </div>
            </dialog>
            <script>
                loading_currency();

                function loading_currency() {
                    var xsend = new XMLHttpRequest();
                    xsend.open("POST", "/CCS/Currency", true);
                    xsend.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            data = JSON.parse(xsend.responseText);
                            console.log(data);
                            if (data.length > 0) {
                                table_body = document.getElementById('table_body_currency');
                                while (table_body.childNodes.length > 0)
                                    table_body.removeChild(table_body.childNodes[0]);
                                for (i = 0; i < data.length; i++) {
                                    var tr = document.createElement("tr");
                                    var tr = document.createElement("tr");
                                    //tdUSD
                                    var formatter = new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'USD',
                                    });

                                    var formatter_EUR = new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'EUR',
                                    });
                                    var formatter_VND = new Intl.NumberFormat('en-US', {
                                        style: 'currency',
                                        currency: 'VND',
                                    });

                                    var tdUSD = document.createElement("td");
                                    tdUSD.setAttribute("class", "mdl-data-table__cell--non-numeric");
                                    var node;
                                    if (data[i].USD == null) node = document.createTextNode(formatter.format("0"));
                                    else node = document.createTextNode(formatter.format(data[i].USD));
                                    tdUSD.appendChild(node);
                                    tr.appendChild(tdUSD);

                                    //EUR
                                    var tdEUR = document.createElement("td");
                                    tdEUR.setAttribute("class", "mdl-data-table__cell--non-numeric");
                                    var node;
                                    if (data[i].EUR == null) node = document.createTextNode(formatter_EUR.format("0"));
                                    else node = document.createTextNode(formatter_EUR.format(data[i].EUR));
                                    tdEUR.appendChild(node);
                                    tr.appendChild(tdEUR);

                                    //VND
                                    var tdVND = document.createElement("td");
                                    tdVND.setAttribute("class", "mdl-data-table__cell--non-numeric");
                                    var node;
                                    if (data[i].CurrentVND == null) node = document.createTextNode(formatter_VND.format("0"));
                                    else node = document.createTextNode(formatter_VND.format(data[i].CurrentVND));
                                    tdVND.appendChild(node);
                                    tr.appendChild(tdVND);

                                    var tdTm = document.createElement("td");
                                    tdTm.setAttribute("class", "mdl-data-table__cell--non-numeric");
                                    if (data[i].TimeUpdate == null) { node = document.createTextNode(''); }
                                    else {
                                        var timeUpdate = (new Date(data[i].TimeUpdate)).toLocaleString("en-US", { timeZone: "Asia/Bangkok" }).split(',')[0];
                                        var node = document.createTextNode(timeUpdate);
                                    }
                                    tdTm.appendChild(node);
                                    tr.appendChild(tdTm)

                                    var tdUser = document.createElement("td");
                                    tdUser.setAttribute("class", "mdl-data-table__cell--non-numeric");
                                    var node;
                                    if (data[i].UserUpdate == null) node = document.createTextNode('');
                                    else node = document.createTextNode(data[i].UserUpdate);
                                    tdUser.appendChild(node);
                                    tr.appendChild(tdUser);

                                    //Action
                                    var tdAssign = document.createElement("td");
                                    tdAssign.setAttribute("class", "mdl-data-table__cell--non-numeric");
                                    var tdbutton_Assign = document.createElement('button');
                                    tdbutton_Assign.setAttribute('class', 'mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored');
                                    tdbutton_Assign.setAttribute('style', 'color:white;background-color:orange');
                                    tdbutton_Assign.innerHTML = '<i class="material-icons">update</i>';
                                    tdbutton_Assign.setAttribute('onclick', 'func_update(this);');
                                    tdAssign.appendChild(tdbutton_Assign);
                                    tr.appendChild(tdAssign);
                                    componentHandler.upgradeElement(tr);
                                    table_body.appendChild(tr);
                                }

                            }
                        }
                    }
                    xsend.setRequestHeader("Content-type", "application/json");
                    xsend.send();
                };


                function func_update() {
                    document.getElementById('txt_vnd').value = '';
                    document.getElementById('txt_eur').value = '';
                    document.getElementById('dialog_currency').showModal();
                }

                function update_currecny_rate() {
                    var rate_eur = document.getElementById('txt_eur').value;
                    var rate_vnd = document.getElementById('txt_vnd').value;


                    if (rate_vnd == '' | rate_eur == '') {
                        alert('Hãy điền đủ thông tin rate cập nhật');
                        return;
                    }

                    if (rate_vnd.length != 5) {
                        alert('kiểm tra lại thông tin giá trị VND');
                        document.getElementById('txt_vnd').value = ''
                        return;
                    }

                    if (parseFloat(rate_eur) > 1.2) {
                        alert('kiểm tra lại thông tin giá trị EUR quá 1.2');
                        document.getElementById('txt_eur').value = ''
                        return;
                    }

                    var xmlhttp = new XMLHttpRequest();
                    xmlhttp.open("POST", '/CCS/UpdateCurrency', true);
                    xmlhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            data = JSON.parse(xmlhttp.responseText);
                            console.log(data);
                            if (data.result == 'fail') {
                                alert("Failed to Update");
                                return;
                            }
                            if (data.result == 'permit') {
                                alert("Bạn không có quyền thay đổi");
                                return;
                            }
                            if (data.result == 'done') {
                                alert("Cập nhật thành công");
                                document.getElementById('dialog_currency').close();
                                loading_currency();
                            }

                        }
                    }
                    xmlhttp.setRequestHeader("Content-type", "application/json");
                    data = {
                        rate_eur: rate_eur,
                        rate_vnd: rate_vnd,
                    };
                    console.log(data)
                    xmlhttp.send(JSON.stringify(data));

                };

                function close_dialog_currency() {
                    document.getElementById('dialog_currency').close();
                }
            </script>
    </div>
</body>

</html>