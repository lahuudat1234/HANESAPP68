<!DOCTYPE html>
<html lang="en" dir="ltr">
    <header>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <!-- <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-purple.min.css"> -->
        <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.purple-indigo.min.css" />
        <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
        <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
        <link rel="stylesheet" href="/JS/getmdl/getmdl-select.min.css"/>
        <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
        <script defer src="/JS/getmdl/getmdl-select.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </header>
    <body ">
        <!-- Always shows a header, even in smaller screens. -->
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <span class="mdl-layout-title">kiểm tra tem dán lại</span>
                    <%- include ("partials/headerTemplate.ejs"); -%>
                </div>
            </header>
            <%- include ("partials/navTemplate.ejs"); -%>
            <main class="mdl-layout__content">
                <div class="page-content">
                    <div style="width: 95%; margin: 10px auto; border-radius: 10px;">
                        <div class="mdl-grid mdl-shadow--6dp" style="background: white; border-radius: 10px;">
                            <div style="margin: 10px auto;">
                                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label has-placeholder" style="width:150px; margin-right: 50px;">
                                    <input class="mdl-textfield__input" type="date" id="date_from">
                                    <label class="mdl-textfield__label" for="date_from">Từ ngày</label>
                                </div>
                                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label has-placeholder" style="width:150px; margin-right: 50px;">
                                    <input class="mdl-textfield__input" type="date" id="date_to">
                                    <label class="mdl-textfield__label" for="date_to">Đến ngày</label>
                                </div>
                                <div id="cbb_group" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height" 
                                        style="width: 100px; margin-right: 50px;">
                                    <input type="text" value="" class="mdl-textfield__input" id="txt_group" readonly>
                                    <input type="hidden" value="" name="groupScan">
                                    <label for="groupScan" class="mdl-textfield__label">Chuyền</label>
                                    <ul for="groupScan" class="mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-shadow--8dp" id="groupScanList">
                                        <li class="mdl-menu__item" data-selected="true">001-008</li>
                                        <li class="mdl-menu__item">001-007</li>
                                        <li class="mdl-menu__item">008-014</li>
                                        <li class="mdl-menu__item">009-014</li>
                                        <li class="mdl-menu__item">015-019</li>
                                        <li class="mdl-menu__item">015-020</li>
                                        <li class="mdl-menu__item">020-024</li>
                                        <li class="mdl-menu__item">020-027</li>
                                        <li class="mdl-menu__item">021-027</li>
                                        <li class="mdl-menu__item">025-029</li>
                                        <li class="mdl-menu__item">030-034</li>
                                        <li class="mdl-menu__item">028-034</li>
                                        <li class="mdl-menu__item">035-042</li>
                                        <li class="mdl-menu__item">043-050</li>
                                        <li class="mdl-menu__item">051-058</li>
                                        <li class="mdl-menu__item">051-059</li>
                                        <li class="mdl-menu__item">059-066</li>
                                        <li class="mdl-menu__item">060-066</li>
                                        <li class="mdl-menu__item">067-074</li>
                                        <li class="mdl-menu__item">075-082</li>
                                        <li class="mdl-menu__item">083-090</li>
                                        <li class="mdl-menu__item">099-105</li>
                                        <li class="mdl-menu__item">091-098</li>
                                        <li class="mdl-menu__item">106-111</li>
                                        <li class="mdl-menu__item">112-118</li>
                                        <li class="mdl-menu__item">200-203</li>
                                        <li class="mdl-menu__item">201-203</li>
                                        <li class="mdl-menu__item">200-234</li>
                                        <li class="mdl-menu__item">204-210</li>
                                        <li class="mdl-menu__item">211-217</li>
                                        <li class="mdl-menu__item">218-224</li>
                                        <li class="mdl-menu__item">225-231</li>
                                        <li class="mdl-menu__item">239-245</li>
                                        <li class="mdl-menu__item">246-252</li>
                                        <li class="mdl-menu__item">253-259</li>
                                        <li class="mdl-menu__item">260-266</li>
                                        <li class="mdl-menu__item">270-276</li>
                                        <li class="mdl-menu__item">277-283</li>
                                        <li class="mdl-menu__item">284-290</li>
                                        <li class="mdl-menu__item">291-297</li>
                                        <li class="mdl-menu__item">298-304</li>
                                        <li class="mdl-menu__item">305-311</li>
                                        <li class="mdl-menu__item">312-318</li>
                                        <li class="mdl-menu__item">319-325</li>
                                        <li class="mdl-menu__item">326-332</li>
                                        <li class="mdl-menu__item">333-339</li>
                                        <li class="mdl-menu__item">340-345</li>
                                        <li class="mdl-menu__item">346-353</li>
                                        <li class="mdl-menu__item">347-353</li>
                                        <!-- <li class="mdl-menu__item">500-600</li>
                                        <li class="mdl-menu__item">700-800</li> -->
                                    </ul>
                                </div>
                                <button class="mdl-button mdl-js-button mdl-button--fab 
                                        mdl-js-ripple-effect mdl-button--colored" id="btn_search">
                                    <i class="material-icons">search</i>
                                </button>
                            </div>
                            <div style="width: 100%;">
                                <div id="spinner" style="margin-left: 50%; margin-top: 5px;"></div>
                            </div>
                            <div id="table_search" class="mdl-card mdl-shadow--6dp" style="width: 90% ; margin: 10px auto; overflow-x:auto; border-radius: 10px; display:none;">
                                <table class="mdl-data-table mdl-js-data-table" style="border: none;">
                                    <thead style="background-color: RED;">
                                        <tr>
                                            <th class="mdl-data-table__cell--non-numeric" style="color: white;">TICKET</th>
                                            <th class="mdl-data-table__cell--non-numeric" style="color: white;">OLD EMP</th>
                                            <th class="mdl-data-table__cell--non-numeric" style="color: white;">OLD FILE</th>
                                            <th class="mdl-data-table__cell--non-numeric" style="color: white;">NEW EMP</th>
                                            <th class="mdl-data-table__cell--non-numeric" style="color: white;">NEW FILE</th>
                                            <th class="mdl-data-table__cell--non-numeric" style="color: white;">STATUS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table_body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </body>
    <dialog id='dialog_image_show' style='width: 90%; border-radius: 10px; border: none;'>
        <div class="mdl-grid">
            <div class="mdl-cell mdl-cell--6-col">
                <div style="margin: 0px auto;">
                    <div class="mdl-textfield mdl-js-textfield">
                        <input class="mdl-textfield__input" type="text" id="image_name1">
                        <label class="mdl-textfield__label" for="image_name1">Nhập tên ảnh</label>
                    </div>
                    <!-- <button class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored" id="image_btn1">
                        <i class="material-icons">close</i>
                    </button> -->
                </div>
                <div>
                    <img id="show_image1" alt="image1" style="width: 100%;">
                </div>
            </div>
            <div class="mdl-cell mdl-cell--6-col">
                <div style="margin: 0px auto;">
                    <div class="mdl-textfield mdl-js-textfield">
                        <input class="mdl-textfield__input" type="text" id="image_name2">
                        <label class="mdl-textfield__label" for="image_name2">Nhập tên ảnh</label>
                    </div>
                    <!-- <button class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored" id="image_btn2">
                        <i class="material-icons">close</i>
                    </button> -->
                    <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="btn_confirm" style="background-color: green; margin-left: 20px;">
                        Save
                    </button>
                    <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="btn_skip" style="background-color: orangered; margin-left: 20px;">
                        Ignore
                    </button>
                    <!-- <button class="mdl-button mdl-js-button mdl-button--fab 
                            mdl-js-ripple-effect mdl-button--colored">
                        <i class="material-icons">done</i>
                    </button>
                    <button class="mdl-button mdl-js-button mdl-button--fab 
                            mdl-js-ripple-effect mdl-button--colored" id="btn_skip">
                        <i class="material-icons">clear</i>
                    </button> -->
                </div>
                <div>
                    <img id="show_image2" alt="image2" style="width: 100%;">
                </div>
            </div>
        </div>
    </dialog>
    <script>
        var ticket="";
        // document.getElementById('image_btn1').addEventListener('click', function(){
        //     document.getElementById('image_name1').value='';
        // });

        // document.getElementById('image_btn2').addEventListener('click', function(){
        //     document.getElementById('image_name2').value='';
        // });
        var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
        var localISOTime = (new Date(Date.now() - tzoffset)).toISOString().slice(0, -1).substr(0,10);
        document.getElementById('date_from').value=localISOTime
        document.getElementById('date_to').value=localISOTime;
        document.getElementById('btn_confirm').addEventListener('click', function(){
            var xsend= new XMLHttpRequest();
            xsend.open("POST","/Production/Payroll_Search/Alert_Update_Status",true);
            xsend.onreadystatechange= function(){
                if (this.readyState==4 && this.status==200){
                    console.log(xsend.responseText);
                    document.getElementById('dialog_image_show').close();
                    document.getElementById('btn_search').click();
                }
            }
            xsend.setRequestHeader("Content-type", "application/json");
            data = {ticket: ticket, status: 'Y'};
            xsend.send(JSON.stringify(data));
        });

        document.getElementById('btn_skip').addEventListener('click', function(){
            var xsend= new XMLHttpRequest();
            xsend.open("POST","/Production/Payroll_Search/Alert_Update_Status",true);
            xsend.onreadystatechange= function(){
                if (this.readyState==4 && this.status==200){
                    console.log(xsend.responseText);
                    document.getElementById('dialog_image_show').close();
                    document.getElementById('btn_search').click();
                }
            }
            xsend.setRequestHeader("Content-type", "application/json");
            data = {ticket: ticket, status: 'I'};
            xsend.send(JSON.stringify(data));
        });

        document.getElementById('btn_search').addEventListener('click', function(){
            table_search.style.display="none";
            var spinner=document.getElementById('spinner');
            spinner.setAttribute("class","mdl-spinner mdl-js-spinner is-active");
            componentHandler.upgradeElement(spinner);
            var body_table_search=document.getElementById("table_body");
            while (body_table_search.childNodes.length>0)
                body_table_search.removeChild(body_table_search.childNodes[0]);
            var xsend= new XMLHttpRequest();
            xsend.open("POST","/Production/Payroll_Search/Alert",true);
            xsend.onreadystatechange= function(){
                if (this.readyState==4 && this.status==200){
                    console.log(xsend.responseText)
                    data=JSON.parse(xsend.responseText);
                    
                    spinner.removeAttribute("class");
                    table_search.style.display="grid";
                    for (var i=0; i<data.length; i++){
                        var tr=document.createElement("tr");
                        //Ticket
                        var tdTicket=document.createElement("td");
                        tdTicket.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].TICKET);
                        tdTicket.appendChild(node);
                        tr.appendChild(tdTicket);
                        //EMP
                        var tdEmployee=document.createElement("td");
                        tdEmployee.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].OLD_EMPLOYEE);
                        tdEmployee.appendChild(node);
                        tr.appendChild(tdEmployee);
                        //FILE
                        var tdFile=document.createElement("td");
                        tdFile.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].OLD_FILE);
                        tdFile.appendChild(node);
                        tr.appendChild(tdFile);
                        //EMP
                        var tdEmployeeN=document.createElement("td");
                        tdEmployeeN.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].NEW_EMPLOYEE);
                        tdEmployeeN.appendChild(node);
                        tr.appendChild(tdEmployeeN);
                        //FILE
                        var tdFileN=document.createElement("td");
                        tdFileN.setAttribute("class","mdl-data-table__cell--non-numeric");
                        var node=document.createTextNode(data[i].NEW_FILE);
                        tdFileN.appendChild(node);
                        tr.appendChild(tdFileN);
                        //Status
                        var tdStatus=document.createElement("td");
                        tdStatus.setAttribute("class","mdl-data-table__cell--non-numeric");
                        if (data[i].STATUS=='Y') tr.style.backgroundColor='orange';
                        var node=document.createTextNode(data[i].STATUS);
                        tdStatus.appendChild(node);
                        tr.appendChild(tdStatus);
                        // tr.setAttribute('ondblclick', 'function_group_search(this, 3, 5)');
                        tr.setAttribute('ondblclick', 'function_find_bundle(this)');
                        componentHandler.upgradeElement(tr);
                        body_table_search.appendChild(tr);
                    }
                }
            }
            xsend.setRequestHeader("Content-type", "application/json");
            var full_date = document.getElementById('date_to').value;
            year          = full_date.substr(0,4);
            month         = full_date.substr(5,2);
            day           = full_date.substr(8,2);
            var date      = year+'-'+month+'-'+day;
            var full_date_from = document.getElementById('date_from').value;
            year_from          = full_date_from.substr(0,4);
            month_from         = full_date_from.substr(5,2);
            day_from           = full_date_from.substr(8,2);
            var date_from      = year_from+'-'+month_from+'-'+day_from;
            group_line=document.getElementById('txt_group').value;
            data          = {date: date, datefrom:date_from, group: group_line};
            xsend.send(JSON.stringify(data));
        });

        function function_find_bundle(x){
            ticket=x.childNodes[0].innerHTML;
            old_file=x.childNodes[2].innerHTML;
            new_file=x.childNodes[4].innerHTML;
            document.getElementById('image_name1').value=old_file;
            document.getElementById('image_name2').value=new_file;
            var bt=document.createElement('button');
            show_image('image_name1', 'show_image1');
            show_image('image_name2', 'show_image2');
            document.getElementById('dialog_image_show').showModal();
        }

        function imageExists(image_url){
            console.log(image_url);
            var http = new XMLHttpRequest();
            http.open('HEAD', image_url, false);
            http.send();
            return http.status != 404;
        }

        document.getElementById('image_name1').addEventListener('keyup', function(event){
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                show_image('image_name1', 'show_image1');
            }
        });

        document.getElementById('image_name2').addEventListener('keyup', function(event){
            if (event.keyCode === 13) {
                // Cancel the default action, if needed
                event.preventDefault();
                // Trigger the button element with a click
                show_image('image_name2', 'show_image2');
            }
        });

        function show_image(img_name, img_element){
            image_name=document.getElementById(img_name).value;
            group=image_name.substring(0, 6)
            shift=image_name.substring(6, 7);
            if (shift=='B') shift="BALI";
            if (shift=='R') shift="RIT";
            day  =image_name.substring(8, 10);
            month=image_name.substring(11, 13);
            year =image_name.substring(14, 18);
            date =year+month+day;
            folder_name=group;
            dateBundle=date;
            folder_root=group;
            shift_record=shift;
            image_name_root=image_name;
            image_date_record=date;
            console.log(image_name, group, shift, date);
            document.getElementById(img_element).src="";
            if (imageExists('../image/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg';
            else if (imageExists('../image/Backup/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image/Backup/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg';
            else if (imageExists('../image5/'+dateBundle+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image5/'+dateBundle+'/'+image_name+'_done.jpg';
            else if (imageExists('../image2/'+dateBundle+'/'+folder_root+'/'+image_name_root+'_done.jpg'))
                document.getElementById(img_element).src='../image2/'+dateBundle+'/'+folder_root+'/'+image_name_root+'_done.jpg';
            else if (imageExists('../image3/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image3/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg';
            else if (imageExists('../image/Backup/'+image_date_record+'/'+shift_record+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image/Backup/'+image_date_record+'/'+shift_record+'/'+folder_name+'/'+image_name+'_done.jpg';
            else if (imageExists('../image4/'+dateBundle+'/'+folder_root+'/'+image_name_root+'_done.jpg'))
                document.getElementById(img_element).src='../image4/'+dateBundle+'/'+folder_root+'/'+image_name_root+'_done.jpg';
            else if (imageExists('../image6/'+dateBundle+'/'+folder_root+'/'+image_name_root+'_done.jpg'))
                document.getElementById(img_element).src='../image6/'+dateBundle+'/'+folder_root+'/'+image_name_root+'_done.jpg';
            else if (imageExists('../image7/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image7/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg';
            else if (imageExists('../image8/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image8/'+date+'/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg';
            else if (imageExists('../image/Pilot/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg'))
                document.getElementById(img_element).src='../image/Pilot/'+shift+'/'+folder_name+'/'+image_name+'_done.jpg';
        }
    </script>
</html>